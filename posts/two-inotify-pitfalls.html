<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Two inotify Pitfalls | subsymbol.org</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="http://www.subsymbol.org/posts/two-inotify-pitfalls.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="L. Amber Wilcox-O'Hearn">
<link rel="prev" href="polyas-urn.html" title="PÃ³lya's Urn" type="text/html">
<link rel="next" href="notes-on-fragment-grammars.html" title="Notes on Fragment Grammars" type="text/html">
<meta property="og:site_name" content="subsymbol.org">
<meta property="og:title" content="Two inotify Pitfalls">
<meta property="og:url" content="http://www.subsymbol.org/posts/two-inotify-pitfalls.html">
<meta property="og:description" content="All I wanted was to track some files.
I have a set of directories populated with files that are hardlinked from other places.
This serves as a kind of database for associating tags to files.
I wanted ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2014-07-31T19:35:05Z">
<meta property="article:tag" content="blog">
<meta property="article:tag" content="emacs">
<meta property="article:tag" content="filesystems">
<meta property="article:tag" content="inotify">
<meta property="article:tag" content="links">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="vim">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../">

            <span id="blog-title">subsymbol.org</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="two-inotify-pitfalls.rst" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../categories/blog/" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../journal/" class="nav-link">Journal</a>
                </li>
<li class="nav-item">
<a href="../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Two inotify Pitfalls</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    L. Amber Wilcox-O'Hearn
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2014-07-31T19:35:05Z" itemprop="datePublished" title="2014-07-31 19:35">2014-07-31 19:35</time></a>
            </p>
                <p class="commentline">
    
    <a href="two-inotify-pitfalls.html#disqus_thread" data-disqus-identifier="cache/posts/two-inotify-pitfalls.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="two-inotify-pitfalls.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>All I wanted was to track some files.</p>
<p>I have a set of directories populated with files that are hardlinked from other places.
This serves as a kind of database for associating tags to files.
I wanted to write a daemon that notifies changes to the files that might affect the consistency of the database.
For example, if the file is removed, I want my database to let go of its reference.</p>
<p>The linux kernel has a set of system calls for this called <a class="reference external" href="http://en.wikipedia.org/wiki/Inotify">inotify</a>, and <a class="reference external" href="http://twistedmatrix.com/documents/current/api/twisted.internet.inotify.html">Twisted has a module to support that API</a>.
Not only that, but the module documentation has everything you need.</p>
<hr class="docutils">
<pre class="code python"><a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-1"></a><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">inotify</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-2"></a><span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">filepath</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-3"></a>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-4"></a><span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">ignored</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-5"></a>    <span class="sd">"""</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-6"></a><span class="sd">    For historical reasons, an opaque handle is passed as first</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-7"></a><span class="sd">    parameter. This object should never be used.</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-8"></a>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-9"></a><span class="sd">    @param filepath: FilePath on which the event happened.</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-10"></a><span class="sd">    @param mask: inotify event as hexadecimal masks</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-11"></a><span class="sd">    """</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-12"></a>    <span class="nb">print</span> <span class="s2">"event </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-13"></a>        <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inotify</span><span class="o">.</span><span class="n">humanReadableMask</span><span class="p">(</span><span class="n">mask</span><span class="p">)),</span> <span class="n">filepath</span><span class="p">)</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-14"></a>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-15"></a><span class="n">notifier</span> <span class="o">=</span> <span class="n">inotify</span><span class="o">.</span><span class="n">INotify</span><span class="p">()</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-16"></a><span class="n">notifier</span><span class="o">.</span><span class="n">startReading</span><span class="p">()</span>
<a name="rest_code_082ecdcd941b4ba58ccacb9eb78399cc-17"></a><span class="n">notifier</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="s2">"/some/directory"</span><span class="p">),</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">notify</span><span class="p">])</span>
</pre>
<hr class="docutils">
<section id="pitfall-1"><h2>Pitfall #1</h2>
<p>Great!  I copy the code, change the path from "/some/directory" to "/home/amber/somedir", and start it up.</p>
<ul class="simple">
<li><p>I make a file, "f", and am notified of its creation, and some attribute change.</p></li>
</ul>
<pre class="code bash"><a name="rest_code_d261a2e45d1349f5b940c311813d6adb-1"></a>$ touch f
</pre>
<pre class="code bash"><a name="rest_code_4e55545098334735b6916dd3ae10767e-1"></a>event create on FilePath<span class="o">(</span><span class="s1">'/home/amber/somedir/f'</span><span class="o">)</span>
<a name="rest_code_4e55545098334735b6916dd3ae10767e-2"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/somedir/f'</span><span class="o">)</span>
</pre>
<ul class="simple">
<li><p>I hard link it with another name</p></li>
</ul>
<pre class="code bash"><a name="rest_code_0b511966d523407bae39f24263556f00-1"></a>$ ln f h
</pre>
<pre class="code bash"><a name="rest_code_db8d9fa463c946d787ffd8d4b09ec42e-1"></a>event create on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/h'</span><span class="o">)</span>
</pre>
<p>Ok.  It logged the creation of h for me, but hasn't this changed the links attribute of f?
Why wasn't I notified of that?</p>
<ul class="simple">
<li><p>I try modifying it.</p></li>
</ul>
<pre class="code bash"><a name="rest_code_b646cb1af81042d69e68006ea267b256-1"></a>$ <span class="nb">echo</span> hello &gt;&gt; h
</pre>
<pre class="code bash"><a name="rest_code_759995010c31429a8023554113f21347-1"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/h'</span><span class="o">)</span>
</pre>
<p>I'm further non-plussed.
This event should have modified both f and h, but I was only notified of the one used in the command.</p>
<p>Finally I try what I really want.
* I make a hard link to f from outside of "somedir/", and modify it through there.</p>
<pre class="code bash"><a name="rest_code_d06909d031b34240b5b045e7ef5322f8-1"></a>$ ln f ../h
<a name="rest_code_d06909d031b34240b5b045e7ef5322f8-2"></a>$ <span class="nb">echo</span> hello &gt;&gt; ../h
</pre>
<pre class="code bash"><a name="rest_code_7c027f1ad68840358f098292625a600e-1"></a><span class="o">(</span>no response<span class="o">)</span>
</pre>
<section id="what-s-going-on"><h3>What's going on?</h3>
<p>Inotify takes a pathname.
If the pathname is a directory, then it watches the directory, but this is not the same as watching each file in the directory.</p>
</section></section><section id="pitfall-2"><h2>Pitfall #2</h2>
<p>Glad to have figured out my error, I try again, modifying the pathname argument in the daemon to "somedir/f".
I remove all those files, touch f, and start the daemon again.
This time it does what I want.</p>
<pre class="code bash"><a name="rest_code_fed253cb37d447fcb810498dcd89d7ca-1"></a>$ ln f h
</pre>
<pre class="code bash"><a name="rest_code_3bb32fd9f0b24982809c346c9b35c2de-1"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
</pre>
<pre class="code bash"><a name="rest_code_c11afccf899f4e6a9404141391d38ef6-1"></a>$ ln f h
<a name="rest_code_c11afccf899f4e6a9404141391d38ef6-2"></a>$ <span class="nb">echo</span> hello &gt;&gt; h
</pre>
<pre class="code bash"><a name="rest_code_5bc2ffe2a26b49c99b9d98288e81defc-1"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_5bc2ffe2a26b49c99b9d98288e81defc-2"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
</pre>
<pre class="code bash"><a name="rest_code_a3487e144f084e8490a4427c7fadea66-1"></a>$ ln f ../h
<a name="rest_code_a3487e144f084e8490a4427c7fadea66-2"></a>$ <span class="nb">echo</span> hello &gt;&gt; ../h
</pre>
<pre class="code bash"><a name="rest_code_f6f5c0681d4a456abdae7106fb53b8b5-1"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_f6f5c0681d4a456abdae7106fb53b8b5-2"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
</pre>
<section id="but-wait"><h3>But wait!</h3>
<p>I was about to call it good, when I decided to try modifying the file with vim or emacs.
I deleted all those files again, touched f, and this time modified it with vim.
On saving the file, I get this:</p>
<pre class="code bash"><a name="rest_code_662be57ba5df4179976ec39908a18c56-1"></a>event move_self on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_662be57ba5df4179976ec39908a18c56-2"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_662be57ba5df4179976ec39908a18c56-3"></a>event delete_self on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
</pre></section><section id="id1"><h3>What's going on?</h3>
<p>It turns out that vim and emacs, and who knows what else, have a trick to save backups while in use.</p>
<p>To see what happens, I edited the daemon to watch the directory again, and also to print some stats about the files:</p>
<pre class="code python"><a name="rest_code_d7592081a04d4217b630cf44913a2361-1"></a><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">inotify</span><span class="p">,</span> <span class="n">reactor</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-2"></a><span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">filepath</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-4"></a>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-5"></a>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-6"></a><span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">ignored</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-7"></a>    <span class="sd">"""</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-8"></a><span class="sd">    For historical reasons, an opaque handle is passed as first</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-9"></a><span class="sd">    parameter. This object should never be used.</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-10"></a>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-11"></a><span class="sd">    @param filepath: FilePath on which the event happened.</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-12"></a><span class="sd">    @param mask: inotify event as hexadecimal masks</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-13"></a><span class="sd">    """</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-14"></a>    <span class="nb">print</span> <span class="s2">"event </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span> <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inotify</span><span class="o">.</span><span class="n">humanReadableMask</span><span class="p">(</span><span class="n">mask</span><span class="p">)),</span> <span class="n">filepath</span><span class="p">)</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-15"></a>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-16"></a>        <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-17"></a>        <span class="nb">print</span> <span class="n">f</span><span class="p">,</span> <span class="s2">"mode:"</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">,</span> <span class="s2">"inode:"</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_ino</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-18"></a>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-19"></a><span class="n">fp</span> <span class="o">=</span> <span class="s2">"/home/amber/subdir"</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-20"></a><span class="n">notifier</span> <span class="o">=</span> <span class="n">inotify</span><span class="o">.</span><span class="n">INotify</span><span class="p">()</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-21"></a><span class="n">notifier</span><span class="o">.</span><span class="n">startReading</span><span class="p">()</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-22"></a><span class="n">notifier</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">notify</span><span class="p">])</span>
<a name="rest_code_d7592081a04d4217b630cf44913a2361-23"></a><span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre>
<p>Now I run it and open f with vi.</p>
<pre class="code bash"><a name="rest_code_6db96f332d2348e1b137102b784dd23b-1"></a>$ vi f
</pre>
<pre class="code bash"><a name="rest_code_061d3a4b137148358617bc4fe32147af-1"></a>event create on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-2"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-3"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-4"></a>event create on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swpx'</span><span class="o">)</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-5"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-6"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-7"></a>event delete on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swpx'</span><span class="o">)</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-8"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-9"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-10"></a>event delete on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-11"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-12"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-13"></a>event create on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-14"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-15"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-16"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-17"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-18"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-19"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-20"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_061d3a4b137148358617bc4fe32147af-21"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
</pre>
<p>(pause)</p>
<pre class="code bash"><a name="rest_code_1b162e5f67c14723ade1337a16d70815-1"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_1b162e5f67c14723ade1337a16d70815-2"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_1b162e5f67c14723ade1337a16d70815-3"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
</pre>
<p>(modify manually)</p>
<pre class="code bash"><a name="rest_code_64137bd4464b406a9d09c06d52776cc1-1"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_64137bd4464b406a9d09c06d52776cc1-2"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_64137bd4464b406a9d09c06d52776cc1-3"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_64137bd4464b406a9d09c06d52776cc1-4"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_64137bd4464b406a9d09c06d52776cc1-5"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_64137bd4464b406a9d09c06d52776cc1-6"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
</pre>
<p>(save manually)</p>
<pre class="code bash"><a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-1"></a>event create on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/4913'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-2"></a>f~ mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-3"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-4"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/4913'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-5"></a>f~ mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-6"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-7"></a>event delete on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/4913'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-8"></a>f~ mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-9"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-10"></a>event moved_from on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-11"></a>f~ mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-12"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-13"></a>event moved_to on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f~'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-14"></a>f~ mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-15"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-16"></a>event create on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-17"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307371</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-18"></a>f~ mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-19"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-20"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-21"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307371</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-22"></a>f~ mode: <span class="m">33204</span> inode: <span class="m">2307370</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-23"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-24"></a>event attrib on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-25"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307371</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-26"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-27"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-28"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307371</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-29"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-30"></a>event delete on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/f~'</span><span class="o">)</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-31"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307371</span>
<a name="rest_code_82b9cfe9cb8943a9aa5a28bff7f00643-32"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
</pre>
<p>(exit)</p>
<pre class="code bash"><a name="rest_code_1a18f29f92c84fcb8b7c818fa12f9ff3-1"></a>event modify on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_1a18f29f92c84fcb8b7c818fa12f9ff3-2"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307371</span>
<a name="rest_code_1a18f29f92c84fcb8b7c818fa12f9ff3-3"></a>.f.swp mode: <span class="m">33188</span> inode: <span class="m">2307363</span>
<a name="rest_code_1a18f29f92c84fcb8b7c818fa12f9ff3-4"></a>event delete on FilePath<span class="o">(</span><span class="s1">'/home/amber/subdir/.f.swp'</span><span class="o">)</span>
<a name="rest_code_1a18f29f92c84fcb8b7c818fa12f9ff3-5"></a>f mode: <span class="m">33204</span> inode: <span class="m">2307371</span>
</pre>
<p>As far as I can tell, the result is as if they have renamed f to something else like f~, copied the contents of f~ to a new file named f, modified f, and finally deleted f~.
This is essentially <a class="reference external" href="http://en.wikipedia.org/wiki/Copy-on-write">copy-on write</a>.</p>
<p>But inotify, while taking pathnames as arguments and returning pathnames, actually tracks inodes.
So simply using an editor has the effect of moving the file to a different inode and thereby breaks inotify!</p>
<p>This is ultimately a consequence of using aliases to files (pathnames) as if they were canonical references to files (inodes).</p>
<!-- **It is a property of mutable objects that -->
</section><section id="post-script-lucky-break"><h3>Post Script: Lucky break?</h3>
<p>As it happens, the behaviour of vim and emacs is different when the inode holding the file has more than one reference.
I can prevent the inode from disappearing by making a hardlink to the file before opening it with an editor.
The editor must have recognised that it can't move inodes willy-nilly when other pathnames depend on it.
This maps exactly to my original scenario, and therefore might make it safe for me to use.
On the other hand, my whole confidence in the bahaviour is undermined, and I am reluctant to rely on it.</p>
</section></section>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../categories/emacs.html" rel="tag">emacs</a></li>
            <li><a class="tag p-category" href="../categories/filesystems.html" rel="tag">filesystems</a></li>
            <li><a class="tag p-category" href="../categories/inotify.html" rel="tag">inotify</a></li>
            <li><a class="tag p-category" href="../categories/links.html" rel="tag">links</a></li>
            <li><a class="tag p-category" href="../categories/linux.html" rel="tag">linux</a></li>
            <li><a class="tag p-category" href="../categories/vim.html" rel="tag">vim</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="polyas-urn.html" rel="prev" title="PÃ³lya's Urn">Previous post</a>
            </li>
            <li class="next">
                <a href="notes-on-fragment-grammars.html" rel="next" title="Notes on Fragment Grammars">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="subsymbol.org",
            disqus_url="http://www.subsymbol.org/posts/two-inotify-pitfalls.html",
        disqus_title="Two inotify Pitfalls",
        disqus_identifier="cache/posts/two-inotify-pitfalls.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="subsymbol.org";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents Â© 2022         <a href="mailto:amber@cs.toronto.edu">L. Amber Wilcox-O'Hearn</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
